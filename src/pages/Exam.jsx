// src/pages/Exam.jsx
import { useEffect, useMemo, useRef, useState } from 'react'
import QuestionCard from '../components/QuestionCard'
import DragDropCard from '../components/DragDropCard'
import TableFillCard from '../components/TableFillCard'
import PieAssignCard from '../components/PieAssignCard'
import ChanceMatrixCard from '../components/ChanceMatrixCard'
import { drawWeighted, shuffle } from '../lib/draw'
import { rollingAccuracy, decideDifficulty, filterByDifficulty } from '../lib/difficulty'
import { recordOutcome, weaknessWeights, areaOf } from '../lib/coach'

export default function Exam({ profile, saveProfile, bank, setView }){
  // ---- konfiguration / val innan start ----
  const [topic, setTopic] = useState('svenska') // 'svenska' | 'matematik'
  const [levelChoice, setLevelChoice] = useState('np') // 'auto'|'easy'|'np'|'hard'
  const [questionCount, setQuestionCount] = useState(profile?.settings?.perExam || 20)
  const [minutes, setMinutes] = useState(profile?.settings?.examTimerTotalMin || 25)
  const [coach, setCoach] = useState(false) // L√§rande prov (hj√§lp/feedback direkt)
  const [focusWeak, setFocusWeak] = useState(false) // vikta mot svaga omr√•den

  // ---- exam state ----
  const [state, setState] = useState('idle') // 'idle' | 'running' | 'review' (coach) | 'finished'
  const [questions, setQuestions] = useState([])
  const [idx, setIdx] = useState(0)
  const [answers, setAnswers] = useState([]) // {qid, chosen, correctIndex, ok}
  const [remaining, setRemaining] = useState(Math.max(1, minutes)*60)
  const timerRef = useRef(null)
  const [showHelp, setShowHelp] = useState(false)
  const [lastExplain, setLastExplain] = useState('')

  // ---- adaptiv niv√• (rekommendation) ----
  const baseMode = profile?.settings?.difficultyMode || 'np'
  const adaptive = !!profile?.settings?.adaptiveDifficulty
  const win = profile?.settings?.adaptWindow ?? 10
  const raiseAt = profile?.settings?.adaptRaiseAt ?? 0.85
  const lowerAt = profile?.settings?.adaptLowerAt ?? 0.55

  const recommendedLevel = useMemo(()=>{
    try{
      const hist = JSON.parse(localStorage.getItem(`hist_${topic}`) || '[]')
      const acc = rollingAccuracy(hist, win)
      return decideDifficulty(baseMode, true, acc, raiseAt, lowerAt)
    }catch(e){ return 'np' }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [topic, baseMode, win, raiseAt, lowerAt])

  const effectiveLevel = levelChoice==='auto' ? (recommendedLevel || 'np') : levelChoice
  const perQSec = profile?.settings?.perQuestionTimerSec || 45 // anv√§nds bara i coach-review n√§r man hoppar vidare
  const noRepeats = profile?.settings?.noRepeats !== false

  // ---- hj√§lpbyggare (kort & tydligt, spoilar ej) ----
  function hoppar(start, steg, antal){ let out = `${start}`, cur = start; for(let i=0;i<Math.max(0,antal);i++){ cur += steg; out += ` ‚îÄ‚îÄ‚ûú ${cur}` } return out }
  function tallinje(start, slut, steg=1){ const asc=start<=slut, dir=asc?1:-1; let cur=start, pts=[cur], guard=12; while((asc&&cur<slut)||(!asc&&cur>slut)){ cur+=dir*Math.abs(steg); pts.push(cur); if(--guard<=0) break } return pts.join('  ‚Üí  ') }
  function buildMathStrategy(q){
    const txt=(q?.q||'').toLowerCase(), area=(q?.area||'matematik').toLowerCase()
    const nums=(txt.match(/-?\d+/g)||[]).map(n=>parseInt(n,10)); const [a,b]=nums
    if(area.includes('addition')){
      if(nums.length>=2){
        const big=Math.max(a,b), small=Math.min(a,b), tillTio=(10-(big%10))%10
        if(tillTio && tillTio<=small){
          return `üéØ G√∂r en tia:\n‚Ä¢ ${big} + ${tillTio} = ${big+tillTio}\n‚Ä¢ L√§gg p√• resten: ${small-tillTio}\n`+hoppar(big,tillTio,1)+` ‚îÄ‚îÄ‚ûú ${big+tillTio}  ‚Ä¶ + ${small-tillTio}`
        }
        return `üéØ R√§kna fr√•n det st√∂rre talet:\n‚Ä¢ B√∂rja p√• ${big} och hoppa ${small} steg.\n`+hoppar(big,1,Math.min(small,6))+(small>6?' ‚Ä¶':'')
      }
      return `üéØ G√∂r hela tiotal f√∂rst.`
    }
    if(area.includes('subtraktion')){
      if(nums.length>=2){
        const from=a, take=b, nerTillTia=from%10
        if(nerTillTia && (take>nerTillTia)){
          return `üéØ Dela upp ner till tia:\n‚Ä¢ ${from} ‚Üí ${from-nerTillTia}\n‚Ä¢ Ta resten: ${take-nerTillTia}\n`+tallinje(from, from-take, nerTillTia)+(take-nerTillTia?`  ‚Üí  ${from-take}`:'')
        }
        return `üéØ R√§kna upp: b√∂rja vid ${from - take} och hoppa till ${from}.\n`+tallinje(from-take, from, 1)
      }
      return `üéØ Ner till j√§mn tia f√∂rst, eller "r√§kna upp".`
    }
    if(area.includes('multiplikation')){
      if(nums.length>=2){
        if(a===9||b===9){ const n=a===9?b:a; return `üéØ 9-knepet: 10√ó${n} ‚àí ${n}` }
        if(a===4||b===4){ const n=a===4?b:a; return `üéØ Dubbla-dubbla (4√ó${n})` }
        if(a===8||b===8){ const n=a===8?b:a; return `üéØ Dubbla tre g√•nger (8√ó${n})` }
        if(a===5||b===5){ const n=a===5?b:a; return `üéØ 5-steg: 5, 10, 15, ‚Ä¶` }
        return `üéØ Bryt upp: n√óm = n√ó(m‚àí1) + n.`
      }
      return `üéØ Upprepad addition eller bryt mot 10.`
    }
    if(area.includes('division')){
      if(nums.length>=2 && b){ return `üéØ Multiplikation bakl√§nges: hur m√•nga ${b}:or ryms i ${a}?` }
      return `üéØ ‚ÄúHur m√•nga grupper?‚Äù.`
    }
    if(area.includes('taluppfattning')){
      if(txt.includes('tiotal')&&a!=null) return `üéØ ${a} = ${Math.floor(a/10)} tiotal och ${a%10} ental.`
      if(txt.includes('st√∂rst')) return `üéØ J√§mf√∂r tiotal f√∂rst, sedan ental.`
      return `üéØ Dela upp i tiotal/ental.`
    }
    if(area.includes('klock')||txt.includes('halv')||txt.includes('kvart')){
      if(txt.includes('halv')) return `üéØ ‚ÄúHalv tre‚Äù = ‚Ä¶:30.`
      if(txt.includes('kvart')) return `üéØ Kvart = 15 min. √ñver = :15, I = :45.`
      return `üéØ Halv = :30, Kvart = :15 / :45.`
    }
    if(area.includes('m√§tning')) return `üéØ 1 m = 100 cm, 1 kg = 1000 g.`
    if(area.includes('geometri')){
      if(txt.includes('h√∂rn')) return `üéØ R√§kna h√∂rn. Kvadrat har 4 h√∂rn.`
      return `üéØ J√§mf√∂r antal sidor/h√∂rn och l√§ngder.`
    }
    if(area.includes('problem')||txt.includes('har ')||txt.includes('f√•r ')) return `üéØ Mini-ekvation: start ¬± f√∂r√§ndring = svar.`
    return `üéØ Dela upp i enkla steg: sikta p√• 10/100, dubbla/halvera, √∂verslag.`
  }
  function conceptHint(q){
    if(q?.hint) return q.hint
    if((q?.topic||'')==='matematik') return buildMathStrategy(q)
    const t=(q?.q||'').toLowerCase()
    const area=(q?.area||'').toLowerCase()
    if(area.includes('grammatik')){
      if(t.includes('substantiv')) return 'Substantiv = namn (katt, bok, Lisa).'
      if(t.includes('verb')) return 'Verb = n√•got man g√∂r/√§r (springer, l√§ser, √§r).'
      if(t.includes('adjektiv')) return 'Adjektiv = beskriver (stor, r√∂d, snabb).'
      if(t.includes('pronomen')) return 'Pronomen = ers√§tter substantiv (han, hon, den).'
      if(t.includes('preposition')) return 'Preposition = l√§ge/riktning (p√•, i, under, bakom).'
      return 'Grammatik: substantiv/verb/adjektiv ‚Äì t√§nk funktion.'
    }
    if(area.includes('stavning')) return 'J√§mf√∂r ljud & bokstav: sj-, tj-, hj-, lj-, dubbelteckning.'
    if(area.includes('ord')) return 'Synonym ‚âà liknande ord. Motsats = tv√§rtom.'
    if(area.includes('l√§s')) return 'L√§s igen och leta ord i texten som matchar fr√•gan.'
    return 'Fundera p√• vad fr√•gan faktiskt fr√•gar efter.'
  }

  // ---- starta provet ----
  function startExam(){
    if(!bank) return
    const storageKey = topic === 'svenska' ? 'exam_sv' : 'exam_ma'

    // adaptiv niv√• f√∂r 'auto'
    let acc = null
    try{
      const hist = JSON.parse(localStorage.getItem(`hist_${topic}`) || '[]')
      acc = rollingAccuracy(hist, win)
    }catch(e){}
    const targetDiff = levelChoice === 'auto'
      ? decideDifficulty(baseMode, adaptive, acc, raiseAt, lowerAt)
      : levelChoice

    // filtrera efter niv√•
    const all = topic==='svenska' ? (bank.svenska?.items||[]) : (bank.matematik?.items||[])
    const pool = filterByDifficulty(all, targetDiff)

    // svaghetsvikter
    let weights = null
    if(focusWeak){
      const areas = Array.from(new Set(pool.map(x => (x.area||'ok√§nd').toLowerCase())))
      weights = weaknessWeights(topic, areas, /*window*/ 80)
    }

    // dra fr√•gor
    let items = drawWeighted(pool, questionCount, weights, storageKey, noRepeats)
      .map(x => ({ ...x, topic }))

    // (svenska) ‚Äì blanda in upp till 3 passagefr√•gor om plats finns
    if(topic==='svenska' && (bank.svenska?.passages?.length||0) > 0 && items.length < questionCount){
      const pass = bank.svenska.passages[Math.floor(Math.random()*bank.svenska.passages.length)]
      const need = Math.min(3, questionCount - items.length)
      const extra = shuffle(pass.questions || []).slice(0, need).map(q=>({
        ...q, title: pass.title, text: pass.text, topic:'svenska', area:'l√§sf√∂rst√•else'
      }))
      items = shuffle([...items, ...extra]).slice(0, questionCount)
    }

    setQuestions(items)
    setIdx(0)
    setAnswers([])
    setState('running')
    setShowHelp(false)
    setLastExplain('')
    // st√§ll timern
    const total = Math.max(1, parseInt(minutes,10) || 25) * 60
    setRemaining(total)
  }

  // ---- prov-timer (total tid) ----
  useEffect(()=>{
    if(state!=='running') return
    clearInterval(timerRef.current)
    timerRef.current = setInterval(()=>{
      setRemaining(r=>{
        if(r<=1){
          clearInterval(timerRef.current)
          finishExam() // tiden slut
          return 0
        }
        return r-1
      })
    }, 1000)
    return ()=> clearInterval(timerRef.current)
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [state])

  function finishExam(){
    clearInterval(timerRef.current)
    setState('finished')
  }

  // ---- svarshantering ----
  function answerCurrent(choiceIndex){
    const q = questions[idx]
    const ok = (choiceIndex === q.correct)

    // logga till coach/historik (p√•verkar framtida √∂vningar)
    recordOutcome(q.topic || topic, q, ok)

    // spara lokalt f√∂r resultat
    setAnswers(prev => [...prev, {
      qid: q.id || `${topic}-${idx}`,
      chosen: choiceIndex,
      correctIndex: q.correct,
      ok
    }])

    // uppdatera profilpo√§ng lite (exam: 3p/r√§tt)
    if(profile && saveProfile){
      const p = { ...profile }
      const t = q.topic || topic
      p.stats = p.stats || {}
      p.stats[t] = p.stats[t] || {answered:0, correct:0}
      p.stats[t].answered++
      if(ok){
        p.stats[t].correct++
        p.points = (p.points||0) + 3
        if(p.points % 50 === 0) p.level = (p.level||1)+1
      }
      saveProfile(p)
    }

    if(coach){
      // visa coach-feedback innan n√§sta
      const coachText = q.topic==='matematik'
        ? buildMathStrategy(q)
        : (q.explain || q.hint || conceptHint(q))
      setLastExplain(coachText)
      setState('review')
    }else{
      // strikt l√§ge: direkt vidare
      goNext()
    }
  }

  function answerBinary(ok){
    answerCurrent(ok ? /*‚Äúr√§tt‚Äù*/ questions[idx]?.correct : /*‚Äúfel‚Äù*/ -999)
  }

  function goNext(){
    const next = idx + 1
    if(next >= questions.length){
      finishExam()
    }else{
      setIdx(next)
      setShowHelp(false)
      setLastExplain('')
      if(coach){
        // ‚Äúper fr√•ga‚Äù-k√§nsla i coach-l√§ge: l√§tt reset-k√§nsla
        // (vi l√§mnar total-timer or√∂rd)
      }
    }
  }

  function restart(){
    clearInterval(timerRef.current)
    setQuestions([]); setIdx(0); setAnswers([]); setShowHelp(false); setLastExplain('')
    setRemaining(Math.max(1, minutes)*60)
    setState('idle')
  }

  // ---- render helpers ----
  const current = questions[idx]
  const progressPct = questions.length ? Math.round((idx/questions.length)*100) : 0
  function fmtTime(s){ const m=Math.floor(s/60), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}` }

  // ---- UI ----
  return (
    <div className="grid">
      <div className="card">
        <h1>üìù Provl√§ge</h1>

        {state==='idle' && (
          <>
            <div className="row" style={{flexWrap:'wrap'}}>
              <span className="chip">√Ñmne:</span>
              <button className="btn small ghost" aria-pressed={topic==='svenska'} onClick={()=>setTopic('svenska')}>üìñ Svenska</button>
              <button className="btn small ghost" aria-pressed={topic==='matematik'} onClick={()=>setTopic('matematik')}>üßÆ Matematik</button>
            </div>

            <div className="row" style={{flexWrap:'wrap', marginTop:8}}>
              <span className="chip">Niv√•:</span>
              {['auto','easy','np','hard'].map(l => (
                <label key={l} className="chip" style={{cursor:'pointer'}}>
                  <input type="radio" name="level" checked={levelChoice===l} onChange={()=>setLevelChoice(l)} />
                  {l==='auto' ? `Auto (${recommendedLevel})` : l.toUpperCase()}
                </label>
              ))}
            </div>

            <div className="row" style={{alignItems:'center', marginTop:8}}>
              <div className="chip">Antal fr√•gor:</div>
              <input
                type="number" min="5" max="40" step="1"
                value={questionCount}
                onChange={e=>setQuestionCount(Math.max(5, Math.min(40, Number(e.target.value)||20)))}
                style={{width:90, padding:'6px', fontSize:'1rem', border:'1px solid #e5e7eb', borderRadius:8}}
              />
            </div>

            <div className="row" style={{alignItems:'center', marginTop:8}}>
              <div className="chip">Provtid (min):</div>
              <input
                type="number" min="5" max="90" step="1"
                value={minutes}
                onChange={e=>setMinutes(Math.max(5, Math.min(90, Number(e.target.value)||25)))}
                style={{width:90, padding:'6px', fontSize:'1rem', border:'1px solid #e5e7eb', borderRadius:8}}
              />
            </div>

            <div className="row" style={{flexWrap:'wrap', marginTop:8}}>
              <label className="chip" style={{cursor:'pointer'}}>
                <input type="checkbox" checked={focusWeak} onChange={e=>setFocusWeak(e.target.checked)} />
                Fokusera p√• svagheter
              </label>
              <label className="chip" style={{cursor:'pointer'}}>
                <input type="checkbox" checked={coach} onChange={e=>setCoach(e.target.checked)} />
                L√§rande prov (Coach)
              </label>
            </div>

            <div className="row" style={{marginTop:10}}>
              <button className="btn small" onClick={startExam}>‚ñ∂Ô∏è Starta prov ({effectiveLevel}, {questionCount})</button>
              <button className="btn small alt" onClick={()=>setView?.('home')}>üè† Hem</button>
            </div>
          </>
        )}

        {state!=='idle' && (
          <div className="row" style={{marginTop:6, flexWrap:'wrap', justifyContent:'space-between'}}>
            <div className="chip">{topic==='matematik'?'üßÆ Matematik':'üìñ Svenska'}</div>
            <div className="chip">Niv√•: {effectiveLevel}</div>
            <div className="chip">‚è≥ Tid kvar: {fmtTime(remaining)}</div>
          </div>
        )}
      </div>

      <div className="card">
        {state==='running' && current && (
          <>
            <div className="row" style={{justifyContent:'space-between', flexWrap:'wrap'}}>
              <div className="chip">Fr√•ga {idx+1} / {questions.length}</div>
              <div className="progress" style={{flex:1, margin:'0 10px'}}><div className="bar" style={{width:`${progressPct}%`}}/></div>
              <div className="pill">{coach ? 'üë©‚Äçüè´ L√§rande' : 'üß™ Standard'}</div>
            </div>

            {/* korttyp */}
            {(() => {
              const common = { locked:false, showHint: coach && showHelp, hintText: coach ? conceptHint(current) : '' }
              switch(current.type){
                case 'dnd': return <DragDropCard q={current} onAnswer={answerBinary} {...common} />
                case 'table-fill': return <TableFillCard q={current} onAnswer={answerBinary} {...common} />
                case 'pie-assign': return <PieAssignCard q={current} onAnswer={answerBinary} {...common} />
                case 'chance-matrix': return <ChanceMatrixCard q={current} onAnswer={answerBinary} {...common} />
                default: return <QuestionCard q={current} onChoose={answerCurrent} {...common} />
              }
            })()}

            <div className="sticky-actions">
              <div className="row">
                {coach && (
                  <button className="btn small ghost" onClick={()=>setShowHelp(h=>!h)}>
                    {showHelp ? 'üÜò Hj√§lp (aktiv)' : 'üÜò Hj√§lp'}
                  </button>
                )}
                {!coach && current?.type === undefined && (
                  <button className="btn small ghost" onClick={()=>answerCurrent(-1)}>‚è≠Ô∏è Skippa</button>
                )}
                {!coach && <button className="btn small" onClick={goNext}>‚û°Ô∏è N√§sta</button>}
                <button className="btn small" onClick={restart}>üîÅ Avsluta</button>
              </div>
            </div>
          </>
        )}

        {state==='review' && current && coach && (
          <>
            <div className="row" style={{justifyContent:'space-between', flexWrap:'wrap'}}>
              <div className="chip">Fr√•ga {idx+1} / {questions.length}</div>
              <div className="progress" style={{flex:1, margin:'0 10px'}}><div className="bar" style={{width:`${progressPct}%`}}/></div>
              <div className="pill">üë©‚Äçüè´ Coach</div>
            </div>

            <div className="hint" style={{marginTop:10, whiteSpace:'pre-wrap', fontFamily:'ui-monospace, Menlo, Consolas, monospace'}}>
              <b>Coach:</b> {lastExplain || 'Fundera p√• begrepp och strategi steg f√∂r steg.'}
            </div>

            <div className="row" style={{marginTop:10}}>
              <button className="btn small" onClick={goNext}>‚û°Ô∏è N√§sta</button>
              <button className="btn small" onClick={restart}>üîÅ Avsluta</button>
            </div>
          </>
        )}

        {state==='finished' && (
          <>
            <h2>üéâ Provet klart!</h2>
            {renderSummary()}
            <div className="row" style={{marginTop:10}}>
              <button className="btn" onClick={startExam}>‚ñ∂Ô∏è G√∂r om ({effectiveLevel}, {questionCount})</button>
              <button className="btn alt" onClick={()=>setView?.('stats')}>üìä Se statistik</button>
              <button className="btn ghost" onClick={()=>setView?.('home')}>üè† Hem</button>
            </div>
          </>
        )}
      </div>
    </div>
  )

  // ---- resultat-sammanfattning med svagheter per area ----
  function renderSummary(){
    if(!answers.length || !questions.length) return <p>Inga svar registrerade.</p>
    const total = answers.length
    const ok = answers.filter(a=>a.ok).length
    const pct = Math.round(100*ok/total)

    // area-agg
    const byArea = {}
    answers.forEach((a,i)=>{
      const q = questions[i]
      const area = (areaOf(q) || 'ok√§nd')
      byArea[area] ||= {right:0, total:0}
      byArea[area].total++
      if(a.ok) byArea[area].right++
    })
    const rows = Object.entries(byArea).map(([area, s])=>({
      area, acc: s.total ? Math.round(100*s.right/s.total) : 0, total: s.total
    })).sort((x,y)=>x.acc - y.acc)

    return (
      <>
        <p><b>Resultat:</b> {ok} / {total} ({pct}%)</p>
        <div className="list" style={{marginTop:10}}>
          {rows.map(r=>(
            <div key={r.area} className="item">
              <div className="row" style={{justifyContent:'space-between'}}>
                <div><b>{r.area}</b></div>
                <div>{r.acc}% ¬∑ {r.total} fr√•gor</div>
              </div>
              <div className="progress" style={{marginTop:6}}><div className="bar" style={{width:`${r.acc}%`}}/></div>
            </div>
          ))}
        </div>
        <p className="tiny" style={{marginTop:10}}>
          Tip: K√∂r √∂vningsl√§ge med <b>Fokusera p√• svagheter</b> s√• tr√§nar du mer p√• omr√•den d√§r du fick l√§gre resultat.
        </p>
      </>
    )
  }
}